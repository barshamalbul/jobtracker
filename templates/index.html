{% extends "base.html" %}
{% block content %}

<div class="mb-3 d-flex justify-content-between">
    <a href="/add" class="btn btn-primary">
        ‚ûï Add Application
    </a>
    <a href="/export_csv" class="btn btn-success">
        ‚¨á Export CSV
    </a>
</div>


<div class="d-flex justify-content-end mb-3 flex-wrap gap-2">
    <!-- Status Filter -->
    <div class="col-md-2 mb-2">
        <form method="get" id="filterForm">
            <select name="status" class="form-select" onchange="document.getElementById('filterForm').submit()">
                <option value="All" {% if status_filter=='All' %}selected{% endif %}>All Status</option>
                <option value="Applied" {% if status_filter=='Applied' %}selected{% endif %}>Applied</option>
                <option value="Interview" {% if status_filter=='Interview' %}selected{% endif %}>Interview</option>
                <option value="Offer" {% if status_filter=='Offer' %}selected{% endif %}>Offer</option>
                <option value="Rejected" {% if status_filter=='Rejected' %}selected{% endif %}>Rejected</option>
            </select>
        </form>
    </div>

    {% include "components/search_bar.html" %}
    
</div>

<div class="row mb-4 text-center" id="dashboardCards">

    <div class="col">
        <div class="card shadow-sm status-card bg-light" data-status="All">
            <div class="card-body">
                <h6>Total</h6>
                <h4 class="count">{{ applications|length }}</h4>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card shadow-sm status-card bg-primary text-white" data-status="Applied">
            <div class="card-body">
                <h6>Applied</h6>
                <h4 class="count">
                    {{ applications | selectattr('status', 'equalto', 'Applied') | list | length }}
                </h4>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card shadow-sm status-card bg-warning text-dark" data-status="Interview">
            <div class="card-body">
                <h6>Interview</h6>
                <h4 class="count">
                    {{ applications | selectattr('status', 'equalto', 'Interview') | list | length }}
                </h4>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card shadow-sm status-card bg-success text-white" data-status="Offer">
            <div class="card-body">
                <h6>Offer</h6>
                <h4 class="count">
                    {{ applications | selectattr('status', 'equalto', 'Offer') | list | length }}
                </h4>
            </div>
        </div>
    </div>

    <div class="col">
        <div class="card shadow-sm status-card bg-danger text-white" data-status="Rejected">
            <div class="card-body">
                <h6>Rejected</h6>
                <h4 class="count">
                    {{ applications | selectattr('status', 'equalto', 'Rejected') | list | length }}
                </h4>
            </div>
        </div>
    </div>

  

</div>



<div class="table-responsive">
    <div class="d-flex justify-content-between align-items-center mb-3">

    <a class="btn btn-outline-secondary {% if not has_prev %}disabled{% endif %}"
       href="{{ url_for('index', page=page-1) }}">
        ‚Üê Previous
    </a>

    <span class="text-muted">
        Page {{ page }}
    </span>

    <a class="btn btn-outline-secondary {% if not has_next %}disabled{% endif %}"
       href="{{ url_for('index', page=page+1) }}">
        Next ‚Üí
    </a>
</div>

<table class="table table-bordered table-hover align-middle">
    <thead class="table-light">
        <tr>
            {% macro sort_link(column_name, display_name) -%}
                {% set new_dir = 'asc' if sort_by != column_name or sort_dir=='desc' else 'desc' %}
                <a href="{{ url_for('index', page=1, status=status_filter, q=search_query, sort_by=column_name, sort_dir=new_dir) }}" class="text-decoration-none text-dark">
                    {{ display_name }}
                    {% if sort_by == column_name %}
                        {% if sort_dir == 'asc' %}
                            ‚ñ≤
                        {% else %}
                            ‚ñº
                        {% endif %}
                    {% endif %}
                </a>
            {%- endmacro %}
            <th>{{ sort_link('id','id') }}</th>
            <th>{{ sort_link('company','Company') }}</th>
            <th>{{ sort_link('job_title','Role') }}</th>
            <th>{{ sort_link('location','Location') }}</th>
            <th>{{ sort_link('job_link','Job Link')}}</th>
            <th>{{ sort_link('notes', 'Notes')}}</th>
            <th>{{ sort_link('date','Date')}}</th>
            <th>{{ sort_link('status','Status') }}</th>
            <th>Action</th>
        </tr>
    </thead>

    <tbody>
    {% for app in applications %}
        <tr class="status-row status-{{ app.status | lower }}"  data-status="{{ app.status }}">
            <td>{{app.id}}</td>
            <td>{{ app.company }}</td>
            <td>{{ app.job_title }}</td>
            <td>{{ app.location }}</td>

            <!-- Job Link (wrapped + clickable) -->
            <td class="text-wrap job-link-cell" style="max-width: 250px;">
                <a href="{{ app.job_link }}" target="_blank" class="job-link">
                    {{ app.job_link }}
                </a>
            </td>
            <td>{{app.notes}}
                <button class="btn btn-sm btn-outline-secondary"
            onclick="openNotesModal('{{ app.id }}', `{{ app.notes or '' }}`)">
        üìù
    </button>
            </td>
            <td>{{ app.applied_date }}</td>

           <td>
                <!-- Status Badge -->
                <span class="status-badge status-{{ app.status | lower }}"
                    id="badge-{{ app.id }}"
                    onclick="enableStatusEdit('{{ app.id }}')">
                    {{ app.status }}
                </span>

                <!-- Hidden Form -->
                <form method="POST"
                    action="/update-status/{{ app.id }}"
                    id="form-{{ app.id }}"
                    class="d-inline"
                    style="display:none;">

                    <select name="status"
                            class="form-select form-select-sm d-inline w-auto"
                            data-original="{{ app.status }}"
                            id="select-{{ app.id }}"
                            onchange="openConfirmModal('{{ app.id }}')">

                        {% for s in ['Applied','Interview','Offer','Rejected'] %}
                            <option value="{{ s }}" {% if app.status == s %}selected{% endif %}>
                                {{ s }}
                            </option>
                        {% endfor %}
                    </select>
                </form>
            </td>



            <td>
                <a href="/edit/{{ app.id }}" class="btn btn-sm btn-warning">Edit</a>
                <a href="/delete/{{ app.id }}"
                   class="btn btn-sm btn-danger"
                   onclick="return confirm('Are you sure you want to delete this application?')">
                   Delete
                </a>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<div class="d-flex justify-content-between align-items-center mb-2">
    <div class="text-muted">
        Showing {{ start_record }}‚Äì{{ end_record }} of {{ total }} applications
    </div>
</div>
</div>

{% endblock %}
